// bootstrap.gradle

def llamaRnDir = file("third_party/llama.rn")
def llamaCppDir = file("third_party/llama.rn/third_party/llama.cpp")
def cppDir = file("cpp")
def scriptsDir = file("third_party/llama.rn/scripts")

task bootstrap {
    group = "llama4aj"
    description = "Bootstraps the project by syncing submodules and copying/patching source files."

    doLast {
        // 1. Initialize/Update Submodules
        logger.lifecycle("Initializing/Updating submodules...")
        exec {
            commandLine "git", "submodule", "update", "--init", "--recursive", "third_party/llama.rn"
        }

        // 2. Clean cpp directory (preserve ajllamaJNI.cpp)
        logger.lifecycle("Cleaning cpp directory...")
        if (cppDir.exists()) {
            cppDir.listFiles().each { f ->
                if (f.name != "ajllamaJNI.cpp" && f.name != "CMakeLists.txt") { // Keep CMakeLists.txt if it exists for now, though we might overwrite/manage it
                    if (f.isDirectory()) {
                        f.deleteDir()
                    } else {
                        f.delete()
                    }
                }
            }
        } else {
            cppDir.mkdirs()
        }

        // 3. Copy files from llama.cpp
        logger.lifecycle("Copying files from llama.cpp...")
        
        // Helper to copy and log
        def copyFile = { File src, File dest ->
            if (src.exists()) {
                dest.parentFile.mkdirs()
                java.nio.file.Files.copy(src.toPath(), dest.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING)
            } else {
                logger.warn("Source file not found: ${src}")
            }
        }

        def copyDir = { File src, File dest ->
            if (src.exists()) {
                copy {
                    from src
                    into dest
                }
            } else {
                logger.warn("Source directory not found: ${src}")
            }
        }

        // GGML API Headers
        copyFile(file("${llamaCppDir}/ggml/include/ggml.h"), file("${cppDir}/ggml.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-alloc.h"), file("${cppDir}/ggml-alloc.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-backend.h"), file("${cppDir}/ggml-backend.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-cpu.h"), file("${cppDir}/ggml-cpu.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-cpp.h"), file("${cppDir}/ggml-cpp.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-opt.h"), file("${cppDir}/ggml-opt.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-metal.h"), file("${cppDir}/ggml-metal.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-opencl.h"), file("${cppDir}/ggml-opencl.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-blas.h"), file("${cppDir}/ggml-blas.h"))
        copyFile(file("${llamaCppDir}/ggml/include/ggml-hexagon.h"), file("${cppDir}/ggml-hexagon.h"))
        copyFile(file("${llamaCppDir}/ggml/include/gguf.h"), file("${cppDir}/gguf.h"))

        // GGML Backends
        copyDir(file("${llamaCppDir}/ggml/src/ggml-metal"), file("${cppDir}/ggml-metal"))
        file("${cppDir}/ggml-metal/CMakeLists.txt").delete()

        // Metal header embedding (simplified logic, matches script mostly)
        // TODO: Implement the awk/sed logic for metal header embedding if needed for macOS.
        // For now, we'll verify if this is strictly necessary for our current goals or if we can rely on file copy.
        // The script embeds headers into .metal file for runtime compilation.
        // We will skip complex sed/awk for now and assume standard copy works for build, 
        // but might need to revisit for full iOS/macOS support parity.

        copyDir(file("${llamaCppDir}/ggml/src/ggml-blas"), file("${cppDir}/ggml-blas"))
        file("${cppDir}/ggml-blas/CMakeLists.txt").delete()

        copyDir(file("${llamaCppDir}/ggml/src/ggml-opencl"), file("${cppDir}/ggml-opencl"))
        file("${cppDir}/ggml-opencl/CMakeLists.txt").delete()

        copyDir(file("${llamaCppDir}/ggml/src/ggml-hexagon"), file("${cppDir}/ggml-hexagon"))
        // Keep CMakeLists.txt for hexagon as noted in script

        // GGML CPU
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/ggml-cpu.c"), file("${cppDir}/ggml-cpu/ggml-cpu.c"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/ggml-cpu.cpp"), file("${cppDir}/ggml-cpu/ggml-cpu.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/ggml-cpu-impl.h"), file("${cppDir}/ggml-cpu/ggml-cpu-impl.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/quants.h"), file("${cppDir}/ggml-cpu/quants.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/quants.c"), file("${cppDir}/ggml-cpu/quants.c"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/arch-fallback.h"), file("${cppDir}/ggml-cpu/arch-fallback.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/repack.cpp"), file("${cppDir}/ggml-cpu/repack.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/repack.h"), file("${cppDir}/ggml-cpu/repack.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/traits.h"), file("${cppDir}/ggml-cpu/traits.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/traits.cpp"), file("${cppDir}/ggml-cpu/traits.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/common.h"), file("${cppDir}/ggml-cpu/common.h"))

        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/unary-ops.h"), file("${cppDir}/ggml-cpu/unary-ops.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/unary-ops.cpp"), file("${cppDir}/ggml-cpu/unary-ops.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/binary-ops.h"), file("${cppDir}/ggml-cpu/binary-ops.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/binary-ops.cpp"), file("${cppDir}/ggml-cpu/binary-ops.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/vec.h"), file("${cppDir}/ggml-cpu/vec.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/vec.cpp"), file("${cppDir}/ggml-cpu/vec.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/simd-mappings.h"), file("${cppDir}/ggml-cpu/simd-mappings.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/ops.h"), file("${cppDir}/ggml-cpu/ops.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-cpu/ops.cpp"), file("${cppDir}/ggml-cpu/ops.cpp"))

        copyDir(file("${llamaCppDir}/ggml/src/ggml-cpu/amx"), file("${cppDir}/ggml-cpu/amx"))
        file("${cppDir}/ggml-cpu/arch").mkdirs()
        copyDir(file("${llamaCppDir}/ggml/src/ggml-cpu/arch/arm"), file("${cppDir}/ggml-cpu/arch/arm"))
        copyDir(file("${llamaCppDir}/ggml/src/ggml-cpu/arch/x86"), file("${cppDir}/ggml-cpu/arch/x86"))

        // GGML Core
        copyFile(file("${llamaCppDir}/ggml/src/ggml.c"), file("${cppDir}/ggml.c"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-impl.h"), file("${cppDir}/ggml-impl.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-alloc.c"), file("${cppDir}/ggml-alloc.c"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-backend.cpp"), file("${cppDir}/ggml-backend.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-backend-impl.h"), file("${cppDir}/ggml-backend-impl.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-backend-reg.cpp"), file("${cppDir}/ggml-backend-reg.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-backend-dl.h"), file("${cppDir}/ggml-backend-dl.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-backend-dl.cpp"), file("${cppDir}/ggml-backend-dl.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-common.h"), file("${cppDir}/ggml-common.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-opt.cpp"), file("${cppDir}/ggml-opt.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-quants.h"), file("${cppDir}/ggml-quants.h"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-quants.c"), file("${cppDir}/ggml-quants.c"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-threading.cpp"), file("${cppDir}/ggml-threading.cpp"))
        copyFile(file("${llamaCppDir}/ggml/src/ggml-threading.h"), file("${cppDir}/ggml-threading.h"))
        copyFile(file("${llamaCppDir}/ggml/src/gguf.cpp"), file("${cppDir}/gguf.cpp"))

        // Llama API
        copyFile(file("${llamaCppDir}/include/llama.h"), file("${cppDir}/llama.h"))
        copyFile(file("${llamaCppDir}/include/llama-cpp.h"), file("${cppDir}/llama-cpp.h"))
        
        copyDir(file("${llamaCppDir}/src/models"), file("${cppDir}/models"))
        
        copyFile(file("${llamaCppDir}/src/llama.cpp"), file("${cppDir}/llama.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-chat.h"), file("${cppDir}/llama-chat.h"))
        copyFile(file("${llamaCppDir}/src/llama-chat.cpp"), file("${cppDir}/llama-chat.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-context.h"), file("${cppDir}/llama-context.h"))
        copyFile(file("${llamaCppDir}/src/llama-context.cpp"), file("${cppDir}/llama-context.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-mmap.h"), file("${cppDir}/llama-mmap.h"))
        copyFile(file("${llamaCppDir}/src/llama-mmap.cpp"), file("${cppDir}/llama-mmap.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-model-loader.h"), file("${cppDir}/llama-model-loader.h"))
        copyFile(file("${llamaCppDir}/src/llama-model-loader.cpp"), file("${cppDir}/llama-model-loader.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-model-saver.h"), file("${cppDir}/llama-model-saver.h"))
        copyFile(file("${llamaCppDir}/src/llama-model-saver.cpp"), file("${cppDir}/llama-model-saver.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-model.h"), file("${cppDir}/llama-model.h"))
        copyFile(file("${llamaCppDir}/src/llama-model.cpp"), file("${cppDir}/llama-model.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-kv-cells.h"), file("${cppDir}/llama-kv-cells.h"))
        copyFile(file("${llamaCppDir}/src/llama-kv-cache.h"), file("${cppDir}/llama-kv-cache.h"))
        copyFile(file("${llamaCppDir}/src/llama-kv-cache.cpp"), file("${cppDir}/llama-kv-cache.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-kv-cache-iswa.h"), file("${cppDir}/llama-kv-cache-iswa.h"))
        copyFile(file("${llamaCppDir}/src/llama-kv-cache-iswa.cpp"), file("${cppDir}/llama-kv-cache-iswa.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-memory-hybrid.h"), file("${cppDir}/llama-memory-hybrid.h"))
        copyFile(file("${llamaCppDir}/src/llama-memory-hybrid.cpp"), file("${cppDir}/llama-memory-hybrid.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-memory-hybrid-iswa.h"), file("${cppDir}/llama-memory-hybrid-iswa.h"))
        copyFile(file("${llamaCppDir}/src/llama-memory-hybrid-iswa.cpp"), file("${cppDir}/llama-memory-hybrid-iswa.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-memory-recurrent.h"), file("${cppDir}/llama-memory-recurrent.h"))
        copyFile(file("${llamaCppDir}/src/llama-memory-recurrent.cpp"), file("${cppDir}/llama-memory-recurrent.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-adapter.h"), file("${cppDir}/llama-adapter.h"))
        copyFile(file("${llamaCppDir}/src/llama-adapter.cpp"), file("${cppDir}/llama-adapter.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-arch.h"), file("${cppDir}/llama-arch.h"))
        copyFile(file("${llamaCppDir}/src/llama-arch.cpp"), file("${cppDir}/llama-arch.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-batch.h"), file("${cppDir}/llama-batch.h"))
        copyFile(file("${llamaCppDir}/src/llama-batch.cpp"), file("${cppDir}/llama-batch.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-cparams.h"), file("${cppDir}/llama-cparams.h"))
        copyFile(file("${llamaCppDir}/src/llama-cparams.cpp"), file("${cppDir}/llama-cparams.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-hparams.h"), file("${cppDir}/llama-hparams.h"))
        copyFile(file("${llamaCppDir}/src/llama-hparams.cpp"), file("${cppDir}/llama-hparams.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-impl.h"), file("${cppDir}/llama-impl.h"))
        copyFile(file("${llamaCppDir}/src/llama-impl.cpp"), file("${cppDir}/llama-impl.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-vocab.h"), file("${cppDir}/llama-vocab.h"))
        copyFile(file("${llamaCppDir}/src/llama-vocab.cpp"), file("${cppDir}/llama-vocab.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-grammar.h"), file("${cppDir}/llama-grammar.h"))
        copyFile(file("${llamaCppDir}/src/llama-grammar.cpp"), file("${cppDir}/llama-grammar.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-sampler.h"), file("${cppDir}/llama-sampler.h"))
        copyFile(file("${llamaCppDir}/src/llama-sampler.cpp"), file("${cppDir}/llama-sampler.cpp"))
        copyFile(file("${llamaCppDir}/src/unicode.h"), file("${cppDir}/unicode.h"))
        copyFile(file("${llamaCppDir}/src/unicode.cpp"), file("${cppDir}/unicode.cpp"))
        copyFile(file("${llamaCppDir}/src/unicode-data.h"), file("${cppDir}/unicode-data.h"))
        copyFile(file("${llamaCppDir}/src/unicode-data.cpp"), file("${cppDir}/unicode-data.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-graph.h"), file("${cppDir}/llama-graph.h"))
        copyFile(file("${llamaCppDir}/src/llama-graph.cpp"), file("${cppDir}/llama-graph.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-io.h"), file("${cppDir}/llama-io.h"))
        copyFile(file("${llamaCppDir}/src/llama-io.cpp"), file("${cppDir}/llama-io.cpp"))
        copyFile(file("${llamaCppDir}/src/llama-memory.h"), file("${cppDir}/llama-memory.h"))
        copyFile(file("${llamaCppDir}/src/llama-memory.cpp"), file("${cppDir}/llama-memory.cpp"))

        // Common Utils
        file("${cppDir}/common").mkdirs()
        copyFile(file("${llamaCppDir}/common/log.h"), file("${cppDir}/common/log.h"))
        copyFile(file("${llamaCppDir}/common/log.cpp"), file("${cppDir}/common/log.cpp"))
        copyFile(file("${llamaCppDir}/common/common.h"), file("${cppDir}/common/common.h"))
        copyFile(file("${llamaCppDir}/common/common.cpp"), file("${cppDir}/common/common.cpp"))
        copyFile(file("${llamaCppDir}/common/sampling.h"), file("${cppDir}/common/sampling.h"))
        copyFile(file("${llamaCppDir}/common/sampling.cpp"), file("${cppDir}/common/sampling.cpp"))
        copyFile(file("${llamaCppDir}/common/json-schema-to-grammar.h"), file("${cppDir}/common/json-schema-to-grammar.h"))
        copyFile(file("${llamaCppDir}/common/json-schema-to-grammar.cpp"), file("${cppDir}/common/json-schema-to-grammar.cpp"))
        copyFile(file("${llamaCppDir}/common/json-partial.h"), file("${cppDir}/common/json-partial.h"))
        copyFile(file("${llamaCppDir}/common/json-partial.cpp"), file("${cppDir}/common/json-partial.cpp"))
        copyFile(file("${llamaCppDir}/common/regex-partial.h"), file("${cppDir}/common/regex-partial.h"))
        copyFile(file("${llamaCppDir}/common/regex-partial.cpp"), file("${cppDir}/common/regex-partial.cpp"))
        copyFile(file("${llamaCppDir}/common/chat.h"), file("${cppDir}/common/chat.h"))
        copyFile(file("${llamaCppDir}/common/chat.cpp"), file("${cppDir}/common/chat.cpp"))
        copyFile(file("${llamaCppDir}/common/chat-parser.h"), file("${cppDir}/common/chat-parser.h"))
        copyFile(file("${llamaCppDir}/common/chat-parser.cpp"), file("${cppDir}/common/chat-parser.cpp"))
        copyFile(file("${llamaCppDir}/common/chat-parser-xml-toolcall.h"), file("${cppDir}/common/chat-parser-xml-toolcall.h"))
        copyFile(file("${llamaCppDir}/common/chat-parser-xml-toolcall.cpp"), file("${cppDir}/common/chat-parser-xml-toolcall.cpp"))
        copyFile(file("${llamaCppDir}/common/chat-peg-parser.h"), file("${cppDir}/common/chat-peg-parser.h"))
        copyFile(file("${llamaCppDir}/common/chat-peg-parser.cpp"), file("${cppDir}/common/chat-peg-parser.cpp"))
        copyFile(file("${llamaCppDir}/common/peg-parser.h"), file("${cppDir}/common/peg-parser.h"))
        copyFile(file("${llamaCppDir}/common/peg-parser.cpp"), file("${cppDir}/common/peg-parser.cpp"))
        copyFile(file("${llamaCppDir}/common/unicode.h"), file("${cppDir}/common/unicode.h"))
        copyFile(file("${llamaCppDir}/common/unicode.cpp"), file("${cppDir}/common/unicode.cpp"))

        // Multimodal
        file("${cppDir}/tools/mtmd").mkdirs()
        copyDir(file("${llamaCppDir}/tools/mtmd/models"), file("${cppDir}/tools/mtmd/models"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd.h"), file("${cppDir}/tools/mtmd/mtmd.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd.cpp"), file("${cppDir}/tools/mtmd/mtmd.cpp"))
        copyFile(file("${llamaCppDir}/tools/mtmd/clip.h"), file("${cppDir}/tools/mtmd/clip.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/clip.cpp"), file("${cppDir}/tools/mtmd/clip.cpp"))
        copyFile(file("${llamaCppDir}/tools/mtmd/clip-impl.h"), file("${cppDir}/tools/mtmd/clip-impl.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/clip-model.h"), file("${cppDir}/tools/mtmd/clip-model.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/clip-graph.h"), file("${cppDir}/tools/mtmd/clip-graph.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd-helper.cpp"), file("${cppDir}/tools/mtmd/mtmd-helper.cpp"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd-helper.h"), file("${cppDir}/tools/mtmd/mtmd-helper.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd-audio.h"), file("${cppDir}/tools/mtmd/mtmd-audio.h"))
        copyFile(file("${llamaCppDir}/tools/mtmd/mtmd-audio.cpp"), file("${cppDir}/tools/mtmd/mtmd-audio.cpp"))

        copyDir(file("${llamaCppDir}/common/jinja"), file("${cppDir}/common/jinja"))
        
        // Jinja renaming (match script logic)
        file("${cppDir}/common/jinja/string.h").renameTo(file("${cppDir}/common/jinja/jinja-string.h"))
        
        // nlohmann & others
        copyDir(file("${llamaCppDir}/vendor/nlohmann"), file("${cppDir}/nlohmann"))
        copyDir(file("${llamaCppDir}/vendor/miniaudio"), file("${cppDir}/tools/mtmd/miniaudio"))
        copyDir(file("${llamaCppDir}/vendor/stb"), file("${cppDir}/tools/mtmd/stb"))

        // --- NEW BACKENDS ---
        logger.lifecycle("Copying extra backends (CUDA, HIP, Vulkan)...")
        copyDir(file("${llamaCppDir}/ggml/src/ggml-cuda"), file("${cppDir}/ggml-cuda"))
        copyDir(file("${llamaCppDir}/ggml/src/ggml-hip"), file("${cppDir}/ggml-hip"))
        copyDir(file("${llamaCppDir}/ggml/src/ggml-vulkan"), file("${cppDir}/ggml-vulkan"))

        // --- RN Custom Files ---
        logger.lifecycle("Copying RN custom files...")
        copyDir(file("${llamaRnDir}/cpp"), cppDir) // This will overwrite with rn-* files

        // 4. Replacements (Prefixing)
        logger.lifecycle("Applying symbol prefixes...")
        
        def filesToProcess = fileTree(dir: cppDir).matching {
            include "**/*.cpp", "**/*.h", "**/*.c", "**/*.cu", "**/*.m", "**/*.metal"
            exclude "rn-*" // Skip rn- files as per script
        }

        filesToProcess.each { File f ->
            if (f.name.startsWith("rn-")) return;

            def content = f.text
            def originalContent = content
            
            content = content.replaceAll("(?<!LM_)GGML_", "LM_GGML_")
            content = content.replaceAll("(?<!lm_)ggml_", "lm_ggml_")
            content = content.replaceAll("(?<!LM_)GGUF_", "LM_GGUF_")
            content = content.replaceAll("(?<!lm_)gguf_", "lm_gguf_")
            content = content.replaceAll("GGMLMetalClass", "LMGGMLMetalClass")
            content = content.replaceAll("<nlohmann/json.hpp>", '"nlohmann/json.hpp"')
            content = content.replaceAll("<nlohmann/json_fwd.hpp>", '"nlohmann/json_fwd.hpp"')
            
            // Jinja includes update
            if (f.path.contains("common/jinja")) {
                 content = content.replaceAll('#include "string.h"', '#include "jinja-string.h"')
                 content = content.replaceAll('#include "jinja/string.h"', '#include "jinja/jinja-string.h"')
            }

            // Quants prefixing (specific files)
            if (f.name == "ggml-quants.h" || f.name == "ggml-quants.c" || f.name == "ggml.c") {
                content = content.replaceAll("iq2xs_init_impl", "lm_iq2xs_init_impl")
                content = content.replaceAll("iq2xs_free_impl", "lm_iq2xs_free_impl")
                content = content.replaceAll("iq3xs_init_impl", "lm_iq3xs_init_impl")
                content = content.replaceAll("iq3xs_free_impl", "lm_iq3xs_free_impl")
            }

            if (content != originalContent) {
                f.text = content
            }
        }

        // 5. Apply Patches
        logger.lifecycle("Applying patches...")
        fileTree(dir: "${scriptsDir}/patches", include: "*.patch").each { File patchFile ->
            logger.lifecycle("Applying patch: ${patchFile.name}")
            exec {
                workingDir cppDir
                commandLine "patch", "-p0", "-i", patchFile.absolutePath
                ignoreExitValue = true // Some patches might be fuzzy or fail if already applied, but in a clean build it should be fine
            }
            // Cleanup orig files
            delete fileTree(dir: cppDir, include: "**/*.orig")
        }
        
        
        // 6. Generate Version Info
        logger.lifecycle("Generating version info...")
        def buildNumber = "0"
        def buildCommit = "unknown"
        
        try {
            def stdout = new ByteArrayOutputStream()
            exec {
                commandLine "git", "rev-list", "--count", "HEAD"
                workingDir llamaCppDir
                standardOutput = stdout
            }
            buildNumber = stdout.toString().trim()
            
            stdout.reset()
            exec {
                commandLine "git", "rev-parse", "--short=7", "HEAD"
                workingDir llamaCppDir
                standardOutput = stdout
            }
            buildCommit = stdout.toString().trim()
        } catch (Exception e) {
            logger.warn("Failed to get git version info: ${e.message}")
        }
        
        def versionFile = file("src/version.ts") // Assuming root/src exists, otherwise maybe just log it or put in cpp
        // The original script puts it in $SRC_DIR/version.ts where SRC_DIR=$ROOT_DIR/src
        // We will match that.
        file("src").mkdirs()
        versionFile.text = """export const BUILD_NUMBER = '${buildNumber}'
export const BUILD_COMMIT = '${buildCommit}'
"""
        logger.lifecycle("Bootstrap complete!")
    }
}
